$(document).ready(function(){
	window.jsPDF = window.jspdf.jsPDF;

	// Tab
	$(".tof-tool-sidebar-tab").click(function(){
		var index = $(this).attr("data-tab-index");
		$(".tof-tool-sidebar-tab").removeClass("selected");
		$(this).addClass("selected");
		$(".tof-tool-sidebar-tab-outer span").css("left", `${index}%`);
	
		var tab = $(this).attr("data-tab");
		$(".tof-tool-sidebar-content").addClass("hidden");
		$(`.tof-tool-sidebar-content[data-tab-content="${tab}"]`).removeClass("hidden");
	});

	// Option Card Slider

	$(".tof-sidebar-option-card-arrow").click(function () {
	    var slider = $(this).parent().find(".tof-side-card-overflow-content");

	    var totalWidth = slider.prop('scrollWidth');
	    var width = slider.width();

	    var lastOffset = parseFloat(slider.attr("data-last-step")) || 0;

	    var scroll = false;
	    var newOffset;

	    if ($(this).hasClass("right")) {
	        newOffset = lastOffset + width;

	        if (newOffset < totalWidth) {
	            slider.attr("data-last-step", newOffset);
	            scroll = true;
	        }
	    } else {
	        newOffset = lastOffset - width;

	        if (newOffset >= 0) {
	            slider.attr("data-last-step", newOffset);
	            scroll = true;
	        }
	    }

	    if(newOffset > 0){
	    	$(this).parent().find(".tof-sidebar-option-card-arrow.left").removeClass('hidden');
	    }else{
	    	$(this).parent().find(".tof-sidebar-option-card-arrow.left").addClass('hidden');
	    }

	    if(newOffset + width >= totalWidth){
	    	$(this).parent().find(".tof-sidebar-option-card-arrow.right").addClass("hidden");
	    }else{
	    	$(this).parent().find(".tof-sidebar-option-card-arrow.right").removeClass("hidden");
	    }

	    if (scroll) {
	        slider.animate({
	            scrollLeft: newOffset
	        }, 500);
	    }
	});

	$(".show-in-full").click(function(){
		$(this).closest(".tof-tool-sidebar-content-section").addClass("full");
		$(".tof-tool-sidebar-content-outer").addClass("show-search");
		$(".tof-sidebar-option-card-wrapper, .tof-add-element-list").show();
	});

	$(".tof-sidebar-info-search svg").click(function(){
		$(".tof-tool-sidebar-content-section").removeClass("full");
		$(".tof-tool-sidebar-content-outer").removeClass("show-search");
		$(".tof-sidebar-option-card-wrapper, .tof-add-element-list").show();
		$("#tof-search-items").val("");
	});

	$("#tof-search-items").on("input", function(){
		let searchQuery = $(this).val().trim().toLowerCase();
		let searchIn = $(".tof-tool-sidebar-content-section.full");
		let searchId = searchIn.attr("data-content-name");

		if(searchId == 'elements'){
			searchIn = searchIn.find(".tof-additional-elements-wrapper > .tof-add-element-list");
		}else if(searchId == 'pages'){
			searchIn = searchIn.find(".tof-side-card-overflow-content > .tof-sidebar-option-card-wrapper");
		}else if(searchId == 'fonts'){
			searchIn = searchIn.find(".tof-side-card-overflow-content > .tof-sidebar-option-card-wrapper");
		}

		searchIn.filter(function(){
			$(this).toggle($(this).text().toLowerCase().indexOf(searchQuery) > -1)
		});
	});


	//  Page Dimension

	function updatePageOuterHeight() {
		// var pageWidth = $(".tof-tool-preview-outer").width();
		// var calcHeight = 1.415*pageWidth;
		// $(".tof-tool-preview-outer").height(calcHeight);
	}

	function updatePageContent(ratio = 1.415, width = 630.75) {
	    if(window.innerWidth > 850){
		    var $previewOuter = $(".tof-tool-preview-outer");
		    var $previewPage = $(".tof-preview-page");
		    var pageContentWidth = $previewOuter.width() - 100;
		    var pageContentHeight = $previewOuter.height();

		    var calcHeight = ratio * width;
		    $previewPage.width(width);
		    $previewPage.height(calcHeight);

		    if (width >= pageContentWidth) {
		        var scale = pageContentWidth / width;

		        // Calculate the top position adjustment
		        if(calcHeight > pageContentHeight){
		        	calcHeight = 120 - (calcHeight - (calcHeight*0.2))/2
			        var topPos = calcHeight;
		        }else{
		        	var topPos = -60
		        }

		        $previewPage.css({
		            "transform": `translateX(-50%) scale(${scale})`,
		            "top": `${topPos}px`
		        });
		    }else{
		    	$previewPage.css({
		            "transform": `translateX(-50%) scale(1)`,
		            "top": `60px`
		        });
		    }
	    }
	}


	/**
	 * Bind CTRL + Plus Key
	 * to zoom in and out
	 * the Paper size
	 */
	$(document).keydown(function(event){
	    if (event.ctrlKey && (event.which === 107 || event.which === 187)) {
		    event.preventDefault();

		    var $previewPage = $(".tof-preview-page");
		    var prevScale = parseFloat($previewPage.css("transform").match(/\d+(\.\d+)?/) || 0);

		    var currentWidth = $previewPage.width();
		    var currentHeight = $previewPage.height();

		    var originX = -(currentWidth * (prevScale + 0.1) - currentWidth) / 2;
		    var originY = -(currentHeight * (prevScale + 0.1) - currentHeight) / 2;

		    $previewPage.css({
		        "transform": `scale(${prevScale + 0.1})`,
		        "transform-origin": `${originX}px ${originY}px`
		    });
		}

		if (event.ctrlKey && (event.which === 109 || event.which === 189)) {
		    event.preventDefault();

		    var $previewPage = $(".tof-preview-page");
		    var prevScale = parseFloat($previewPage.css("transform").match(/\d+(\.\d+)?/) || 0);

		    if (prevScale > 0.15) {
		        var currentWidth = $previewPage.width();
		        var currentHeight = $previewPage.height();

		        var originX = -(currentWidth * (prevScale - 0.1) - currentWidth) / 2;
		        var originY = -(currentHeight * (prevScale - 0.1) - currentHeight) / 2;

		        $previewPage.css({
		            "transform": `scale(${prevScale - 0.1})`,
		            "transform-origin": `${originX}px ${originY}px`
		        });
		    }
		}
	});



	updatePageOuterHeight();
	$(window).resize(() => {
		updatePageOuterHeight();
	});


	/**
	 * Adding Elements
	 * Transformation, &
	 * Resize
	 */

	function randomString(length){
	    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
	    let result = '';
	    for(let i = 0; i < length; i++) {
	      const randomIndex = Math.floor(Math.random() * characters.length);
	      result += characters.charAt(randomIndex);
	    }
	    return result;
	}

	$(document).on("click", ".tof-preview-overlay-element", function(e){
		e.stopPropagation();

		var ElmWidth = $(this).css("width");
		var ElmHeight = $(this).css("height");
		var ElmPosX = $(this).css("left");
		var ElmPosY = $(this).css("top");

		var identifier = randomString(6);
		$(this).attr("id", identifier);

		$(".tof-transform").css({
			"width" : ElmWidth,
			"height" : ElmHeight,
			"left" : ElmPosX,
			"top" : ElmPosY
		});

		if($(this).prop("tagName").toLowerCase() != "img"){
			$(".tof-preview-overlay-element").addClass("no-select");
			$(this).removeClass("no-select");
			$(this).attr("contenteditable", true);
		}

		$(".tof-transform").attr("data-transform-element", identifier);
		$(".tof-transform").removeClass("hidden");

		$(this).on("input", function(){
			$(".tof-transform").width($(this).width());
			$(".tof-transform").height($(this).height());
			updateFormattingPos();
		});
	});

	$(document).on("keyup", function(e) {
	    if (e.keyCode == 46) {
	        var focusedElement = $(document.activeElement);
	        if(!focusedElement.is('[contenteditable="true"], input')) {
	            if(!$(".tof-transform").hasClass("hidden")) {
	                var targetElemName = $(".tof-transform").attr("data-transform-element");
	                var targetElem = $("#" + targetElemName);
	                targetElem.remove();
	                $(".tof-preview-page").trigger("click");
	            }
	        }
	    }
	});


	$(".tof-transform").on("click", function(e){
		e.stopPropagation();
	});

	$(document).on("click", function(){
		$(".tof-transform").addClass("hidden");
	});

	var isMoving = false;
	var initialPos = {x:0, y:0};

	var isResizing = false;
	var action = "";
	var initialState = 0;

	var pos = {x:0,y:0};

	$(".tof-resize-arrow").on("mousedown", function(e){
		$(".tof-formatting").removeClass("show");

		isResizing = true;
		pos.x = e.pageX;
		pos.y = e.pageY;

		action = $(this).attr("data-dir");
		var targetElemName = $(".tof-transform").attr("data-transform-element");
		var targetElem = $("#"+targetElemName);

		if(action == "e" || action == "w"){
			initialState = targetElem.width();
		}else if(action == "n" || action == "s"){
			initialState = targetElem.height();
		}
	});

	$(".tof-move-arrow").on("mousedown", function(e){
		e.stopPropagation();
		e.preventDefault();

		isMoving = true;
		pos.x = e.pageX;
		pos.y = e.pageY;

		action = $(this).attr("data-dir");

		var targetElemName = $(".tof-transform").attr("data-transform-element");
		var targetElem = $("#"+targetElemName);

		initialPos.x = parseFloat(targetElem.css("left").split("px")[0]);
		initialPos.y = parseFloat(targetElem.css("top").split("px")[0]);
	});

	$(document).on("mousedown", ".tof-preview-overlay-element", function(e){
		if($(this).prop("tagName").toLowerCase() == "img"){
			$(this).trigger("click");

			e.stopPropagation();
			e.preventDefault();

			isMoving = true;
			pos.x = e.pageX;
			pos.y = e.pageY;

			action = $(this).attr("data-dir");

			var targetElemName = $(".tof-transform").attr("data-transform-element");
			var targetElem = $("#"+targetElemName);

			initialPos.x = parseFloat(targetElem.css("left").split("px")[0]);
			initialPos.y = parseFloat(targetElem.css("top").split("px")[0]);
		}
	});

	$(document).on("mousemove", function(e){
		if(isResizing){
			if(action != ""){
				var targetElemName = $(".tof-transform").attr("data-transform-element");
				var targetElem = $("#"+targetElemName);
		
				if(action == "e"){
					var offsetX = e.pageX;
					var diff = e.pageX - pos.x;
					var newWidth = initialState+diff;

					if(newWidth < $(".tof-preview-overlay").width()){
						if(targetElem.prop("tagName").toLowerCase() == "img"){
							targetElem.css("width", `${newWidth}px`);
							targetElem.css("height", `unset`);
						}else{
							targetElem.css("width", `${newWidth}px`);
						}
						
						$(".tof-transform").css({
							"width":`${newWidth}px`,
							"height":targetElem.css("height")
						});
					}
				}else if(action == "w"){
					var offsetX = e.pageX;
					var diff = pos.x - e.pageX;
					var newWidth = initialState+diff;

					if(newWidth < $(".tof-preview-overlay").width()){
						if(targetElem.attr("data-initial-horizontal") === undefined){
							let l = parseFloat(targetElem.css("left").split("px")[0]);
							targetElem.attr("data-initial-horizontal", l);
						}

						var leftPos = parseFloat(targetElem.attr("data-initial-horizontal"));
						leftPos = leftPos - diff;

						if(targetElem.prop("tagName").toLowerCase() == "img"){
							targetElem.css({
								"width":`${newWidth}px`,
								"height": `unset`,
								"left" : `${leftPos}px`
							});
						}else{
							targetElem.css({
								"width":`${newWidth}px`,
								"left" : `${leftPos}px`
							});
						}


						$(".tof-transform").css({
							"width":`${newWidth}px`,
							"height":targetElem.css("height"),
							"left" : `${leftPos}px`
						});
					}
				}else if(action == "n"){
					var offsetY = e.pageY;
					var diff = pos.y - e.pageY;
					var newHeight = initialState+diff;

					if(newHeight < $(".tof-preview-overlay").width()){
						if(targetElem.attr("data-initial-vertical") === undefined){
							var t = parseFloat(targetElem.css("top").split("px")[0]);
							targetElem.attr("data-initial-vertical", t);
						}

						var topPos = parseFloat(targetElem.attr("data-initial-vertical"));
						topPos = topPos - diff;

						if(targetElem.prop("tagName").toLowerCase() == "img"){
							targetElem.css({
								"width":`unset`,
								"height": `${newHeight}px`,
								"top" : `${topPos}px`
							});
						}else{
							targetElem.css({
								"height":`${newHeight}px`,
								"top":`${topPos}px`,
							});
						}


						$(".tof-transform").css({
							"height":`${newHeight}px`,
							"width":targetElem.css("width"),
							"top" : `${topPos}px`,
						});
					}
				}else if(action == "s"){
					var offsetY = e.pageY;
					var diff = e.pageY - pos.y;
					var newHeight = initialState+diff;

					if(newHeight < $(".tof-preview-overlay").height()){
						
						if(targetElem.prop("tagName").toLowerCase() == "img"){
							targetElem.css({
								"width":`unset`,
								"height": `${newHeight}px`
							});
						}else{
							targetElem.css({
								"height":`${newHeight}px`
							});
						}

						$(".tof-transform").css({
							"height":`${newHeight}px`,
							"width":targetElem.css("width")
						});
					}
				}
			}
		}

		if(isMoving){
			updateFormattingPos();

			var posX = e.pageX - pos.x;
			var posY = e.pageY - pos.y;

			var movedInX = initialPos.x + posX;
			var movedInY = initialPos.y + posY;

			var targetElemName = $(".tof-transform").attr("data-transform-element");
			var targetElem = $("#"+targetElemName);

			let pageWidth = $(".tof-preview-overlay").width();
			let pageHeight = $(".tof-preview-overlay").height();

			movedInX = (movedInX < 0)?0:movedInX;
			movedInY = (movedInY < 0)?0:movedInY;

			if((movedInX + targetElem.width()) > pageWidth){
				movedInX = pageWidth - targetElem.width();
			}

			if((movedInY + targetElem.height()) > pageHeight){
				movedInY = pageHeight - targetElem.height();
			}
			
			targetElem.css({
				"top" : `${movedInY}px`,
				"left" : `${movedInX}px`
			});

			$(".tof-transform").css({
				"top" : `${movedInY}px`,
				"left" : `${movedInX}px`
			});
		}
	});

	$(document).on("mouseup", function(){
		isResizing = false;
		$('[data-initial-vertical]').removeAttr("data-initial-vertical");
		$('[data-initial-horizontal]').removeAttr("data-initial-horizontal");

		isMoving = false;
		moveImage = false;
	});

	$(document).on('paste', '.tof-preview-overlay-element', function(e){
	    e.preventDefault();
	    var text = (e.originalEvent || e).clipboardData.getData('text/plain');

	    if(isCaretInArea()){
		    document.execCommand('insertText', false, text);
	    }
	});

	$(".tof-formatting-button").on("click", function(){
		updateFormattingPos();

		var targetElemName = $(".tof-transform").attr("data-transform-element");
		var targetElem = $("#"+targetElemName);

		if(targetElem.attr("data-on-all") == "0"){
			$(".tof-fixed-on-all").removeClass("pinned");
		}else{
			$(".tof-fixed-on-all").addClass("pinned");
		}

		$(".tof-formatting").addClass("show");
	});

	$(".tof-formatting").on("click", function(e){
		e.stopPropagation();
	});

	$(document).on("click", function(e){
		$(".tof-formatting").removeClass("show");
	});

	$(".tof-delete-element").click(function(e){
		var targetElemName = $(".tof-transform").attr("data-transform-element");
		var targetElem = $("#"+targetElemName);

		targetElem.remove();
		$(document).trigger("click");
	});

	$(".tof-fixed-on-all").click(function(e){
		var targetElemName = $(".tof-transform").attr("data-transform-element");
		var targetElem = $("#"+targetElemName);

		if(targetElem.attr("data-on-all") == "0"){
			targetElem.attr("data-on-all", "1");
			$(this).addClass("pinned");
		}else{
			targetElem.attr("data-on-all", "0");
			$(this).removeClass("pinned");
		}

		updateNewStyle();
	});

	$(".tof-cancel-element").click(function(e){
		$(".tof-formatting").removeClass("show");
	});

	$('button[data-action]').on("click", function(){
		var formatting = $(this).attr("data-action");

		if(formatting == "foreColor" || formatting == "hiliteColor"){
			formatText(formatting, $(this).attr("data-color"));
		}else{
			formatText(formatting);
		}
	});
	
	$('[data-other-formatting="true"]').on("change", function () {
	    if (isCaretInArea()) {
	        var elem = getSelectedBlockElement();

	        if (elem) {
	            if ($(elem).prop("tagName").toLowerCase() != "span") {
	                const sel = window.getSelection();
	                const range = sel.getRangeAt(0);
	                const stringContent = sel.toString();

	                if (range && range.commonAncestorContainer.nodeType === Node.TEXT_NODE) {
	                    const span = document.createElement("span");
	                    $(span).css($(this).attr("data-formatting-name"), `${$(this).val()}px`);

	                    range.surroundContents(span);
	                }else{
	                    range.deleteContents();
	                    range.insertNode(document.createTextNode(stringContent));
	                }
	            } else {
	                $(elem).css($(this).attr("data-formatting-name"), `${$(this).val()}px`);
	            }
	        }
	    }
	});


	$(".tof-formatting-pick-color").on("click", function(){
	    var forElemName = $(this).attr("data-for");
	    var forElem = $(`button[data-action="${forElemName}"]`);

	    $("._tof-formatting-inp-color-picker").remove();

	    var picker = $("<input/>", {"style":"display:none", "type":"color", "class":"_tof-formatting-inp-color-picker"});
	    picker.css({
	        "position" : "absolute",
	        "top" : $(this).offset().top,
	        "left" : $(this).offset().left,
	        "z-index" : "5"
	    });

	    $("body").prepend(picker);

	    picker.val(forElem.attr("data-color"));
	    picker.on("click", function(e){
	    	e.stopPropagation();
	    });
	    picker.click();

	    picker.on("input", function(){
	    	var hex = $(this).val();
	    	forElem.attr("data-color", hex);
	    	
	    	if(forElemName == "foreColor"){
	    		forElem.find("svg").attr("style", `fill: ${hex} !important`);
	    	}else if(forElemName == "hiliteColor"){
	    		forElem.find("svg").attr("style", `background-color: ${hex} !important`);
	    	}
	    });
	});

	function isCaretInArea() {
	    var specificClass = $('.tof-preview-overlay-element');
	    var selection = window.getSelection();

	    if (selection.rangeCount > 0) {
	        var range = selection.getRangeAt(0);

	        if (specificClass.is($(range.commonAncestorContainer).closest('.tof-preview-overlay-element'))) {
	            return true;
	        }
	    }

	    return false;
	}

	function formatText(command, value=null) {
     	if(isCaretInArea()){
	        document.execCommand(command, false, value);
	        updateFormattingButtons();
     	}
    }

    function getSelectedBlockElement() {
	    var selection = window.getSelection();
	    if (selection.rangeCount > 0) {
	        var range = selection.getRangeAt(0);
	        var container = range.commonAncestorContainer;

	        // Find the nearest block-level element
	        while (container && container.nodeType !== 1) {
	            container = container.parentNode;
	        }

	        return container;
	    }
	    return null;
	}

    $(document).on("selectionchange", function(e){
		updateFormattingButtons();
	});

    function updateFormattingPos() {
		let topPos = parseFloat($(".tof-transform").css("top").split("px")[0]);
		let leftPos = parseFloat($(".tof-transform").css("left").split("px")[0]);
		let pageWidth = $(".tof-preview-overlay").width();

		let rightMostPos = pageWidth - $(".tof-formatting").width();

		topPos += $(".tof-transform").height() + 20;
		leftPos += ($(".tof-transform").width() - $(".tof-formatting").width())/2; 

		let topIconpos = $(".tof-formatting").width()/2 - $(".tof-formatting-top-icon").width();

		if(leftPos < 0){
			leftPos = 0;

			topIconpos = parseFloat($(".tof-transform").css("left").split("px")[0]);
		}else if(leftPos > rightMostPos){
			leftPos = rightMostPos;

			let transformRight = parseFloat($(".tof-transform").css("left").split("px")[0]) + ($(".tof-transform").width()/2);
			transformRight = pageWidth - transformRight;

			topIconpos = $(".tof-formatting").width() - transformRight;
		}

		topIconpos += 10;

		if(topIconpos > ($(".tof-formatting").width() - 20)){
			topIconpos = ($(".tof-formatting").width() - 20);
		}

		$(".tof-formatting-top-icon").css("left", `${topIconpos}px`);

		$(".tof-formatting").css({
			"left" : `${leftPos}px`,
			"top" : `${topPos}px`
		});
	}

	function updateFormattingButtons(){
		$('[data-formatting="true"]').each(function(index, elem){
			var formattingName = $(elem).attr("data-action");

			if(document.queryCommandState(formattingName)){
				$(this).addClass("checked");
			}else{
				$(this).removeClass("checked");
			}
		});

		var selectedElem = getSelectedBlockElement();

		$('[data-other-formatting="true"]').each(function(index, elem){
			let formName = $(this).attr("data-formatting-name");

			if(selectedElem){
				let formValue = $(selectedElem).css(formName).split("px")[0];
				$(elem).val(formValue);
			}
		});
	}


	$('.tof-sidebar-option-card[data-font]').each((index, elem) => {
		$(elem).find(".tof-sidebar-option-card-content").attr("style", `font-family : "${$(elem).attr("data-font")}", sans-serif`);
	});


	/**
	 * Save User changes
	 * to LocalStorage
	 */

	if(localStorage.getItem("inputData")){
		$("#tof-user-input").val(localStorage.getItem("inputData"));
	}

	$("#tof-user-input").on("input", function(){
		localStorage.setItem("inputData", $(this).val().trim());
	});

	$(".tof-tool-import-excel").on("click", function(){
		$(".excel-sheet-full").trigger("click")
		$(".excel-sheet-wrapper").show()
		$(".tof-sidebar-info-search input").css("visibility", "hidden")
		$(".tof-sidebar-info-search").css({"border-bottom":"1px solid var(--division-border)", "padding-bottom":"15px"})
	});

	$(".tof-sidebar-info-search svg").click(function(){
		$(".excel-sheet-wrapper").hide()
		$(".tof-sidebar-info-search input").css("visibility", "visible")
		$(".tof-sidebar-info-search").css({"border-bottom":"none", "padding-bottom":"unset"})
	});

	
	/**
	 * Tool Scripts
	 * From Here..
	 * .....
	 */
	
	var inputTimeout = null;
	const UPDATE_INTERVAL = 400;

	var uploadedCustomPage = false;

	var filters = {
		"font-size" : 0,
		"font-family" : "",
		"line-height" : 0,
		"word-spacing" : 0,
		"letter-spacing" : 0,
		"width" : 0,
		"height" : 0,
		"color" : "",
		"margin-top" : 0,
		"margin-left" : 0,
		"background-image" : "",
		"page" : "",
		"captureEffect" : "",
	};

	var pageCount = 1;
	var currentPage = 1;

	var classicMode = false;

	$("#tof-user-input").on("input", function(){
		var input = $(this).val().replaceAll("<", "&lt;");

		clearTimeout(inputTimeout);
		inputTimeout = setTimeout(function(){
			updateText(input);
		}, UPDATE_INTERVAL);
	});

	$('[data-type="style-input"]').on("input", function(){
		clearTimeout(inputTimeout);
		inputTimeout = setTimeout(function(){
			updateStyle();
		}, UPDATE_INTERVAL);
	});

	$("#tof-page-style .tof-sidebar-option-card").on("click", function(){
		var selectedPage = $(this);
		
		
		if(selectedPage.attr("data-action") != "upload"){
			$("#tof-page-style .tof-sidebar-option-card").addClass("no-transition").removeClass("selected");

			$(selectedPage).addClass("selected");

			setTimeout(function(){
				$("#tof-page-style .tof-sidebar-option-card").removeClass("no-transition");
			}, 0);
			
			var defaultPageSettings = $(selectedPage).attr("data-settings");

			if(isJSON(defaultPageSettings)){
				defaultPageSettings = JSON.parse(defaultPageSettings);
				
				for(setting in defaultPageSettings){
					$(`[data-type="style-input"][data-name="${setting}"]`).val(defaultPageSettings[setting]).trigger("input");
				}
			}

			$("#tof-page-font .tof-sidebar-option-card.selected").trigger("click");
			uploadedCustomPage = false;

			updatePageContent()
		}else{
			// Upload Custom Page
			$(".tof-browser-page-input").remove();

			let browsePage = $("<input/>", {"type" : "file", "style" : "display:none", "class" : "tof-browser-page-input", "accept":".jpeg, .png, .jpg, .gif, .svg, .bmp, .webp, .tiff"});
			$("body").append(browsePage);
			browsePage.click();

			browsePage.on("change", function(){
				let uploadedPage = $(this)[0].files[0];
				
				var allowedTypes = ['image/jpeg', 'image/png', 'image/svg+xml', 'image/bmp', 'image/webp', 'image/tiff'];
    			

    			if(allowedTypes.includes(uploadedPage.type)){
					let reader = new FileReader();

					reader.onload = function(e){
    					$(".tof-preview-page").css("background-image", `url(${e.target.result})`);
						filters["background-image"] = e.target.result;
						uploadedCustomPage = true;

						var img = new Image()

						img.onload = function(){
							updatePageContent(this.height/this.width, this.width)

							$(`[data-type="style-input"][data-name="width"]`).val($(".tof-preview-page").width()).trigger("input");
							$(`[data-type="style-input"][data-name="height"]`).val($(".tof-preview-page").height()).trigger("input");
							$(`[data-type="style-input"][data-name="margin-left"]`).val("0").trigger("input");
							$(`[data-type="style-input"][data-name="margin-top"]`).val("0").trigger("input");
						}

						img.src = e.target.result


					}

					reader.readAsDataURL(uploadedPage);
    			}else{
    				alert("Not Allowed")
    			}
			});
		}
	});

	$("#tof-page-font .tof-sidebar-option-card").on("click", function(){
		$("#tof-page-font .tof-sidebar-option-card").addClass("no-transition").removeClass("selected");
		
		$(this).addClass("selected");

		setTimeout(function(){
			$("#tof-page-font .tof-sidebar-option-card").removeClass("no-transition");
		}, 0);

		if($(this).attr("data-action") == "upload"){
			
			$(".tof-browser-font-input").remove();

			let browseFont = $("<input/>", {"type" : "file", "style" : "display:none", "class" : "tof-browser-font-input", "accept" : ".ttf, .otf, .woff, .woff2"});
			$("body").append(browseFont);
			browseFont.click();

			browseFont.on("change", function(){
				let uploadedFont = $(this)[0].files[0];

				var allowedFontTypes = ['ttf', 'otf', 'woff', 'woff2'];

    			if(allowedFontTypes.includes(uploadedFont.name.split(".").pop().toLowerCase())){
					let reader = new FileReader();

					reader.onload = function(e){
						const newFont = new FontFace('tempFont', `url(${e.target.result})`);
						
						newFont.load().then((loadedFace) => {
						    document.fonts.add(loadedFace);
						    
						    $('.tof-sidebar-option-card[data-action="upload"]').attr("data-font", "tempFont");
						    
						    $('[data-type="style-input"]').trigger("input");
						});
					}

					reader.readAsDataURL(uploadedFont);
    			}
			});

			$('.tof-sidebar-option-card[data-action="upload"]').find("svg").attr("style", "fill:#fff");	
		}else{
			$('.tof-sidebar-option-card[data-action="upload"]').find("svg").attr("style", "fill:gray");
			$('[data-type="style-input"]').trigger("input");
		}

		// Set Default Styling for font Families
		let defaultPageSettings = $("#tof-page-style .tof-sidebar-option-card.selected").attr("data-settings");;
		let newSetting = "{}";

		if($(this).attr("data-settings") !== undefined){
			newSetting = $(this).attr("data-settings");
		}
		
		if(isJSON(defaultPageSettings) && isJSON(newSetting)){
			defaultPageSettings = JSON.parse(defaultPageSettings);
			newSetting = JSON.parse(newSetting);
			
			for(key in newSetting){
				defaultPageSettings[key] += newSetting[key];
			}

			for(setting in defaultPageSettings){
				$(`[data-type="style-input"][data-name="${setting}"]`).val(defaultPageSettings[setting]).trigger("input");
			}
		}
	});

	$("#tof-page-style .tof-sidebar-option-card.selected").trigger("click");


	$("#tof-next-page").click(function(){
		if($(this).hasClass("active")){

			if(currentPage < pageCount){
				currentPage++;
				updateNewStyle();
			}
		}
	});

	$("#tof-prev-page").click(function(){
		if($(this).hasClass("active")){

			if(currentPage > 1){
				currentPage--;
				updateNewStyle();
			}
		}
	});

	$(document).on("click", ".tof-add-element-list", function(){
		var elemName = $(this).attr("data-element");
		var elem = $(`<${elemName}>`);

		if($(this).hasClass("excel-placeholder")){
			var columnIndex = $(this).attr("data-column");

			elem.attr({
				"class" : "tof-preview-overlay-element",
				"data-excel-placeholder" : "1",
				"data-excel-column" : columnIndex,
				"data-on-page" : currentPage,
				"data-on-all" : "0",
				"style" : `font-size:20px; width: auto; top: 20%; left: ${Math.floor(Math.random() * 80)}%;`
			});
		}else{
			elem.attr({
				"class" : "tof-preview-overlay-element",
				"data-on-page" : currentPage,
				"data-on-all" : "0",
				"style" : "font-size:20px"
			});
		}
		


		if(elemName == "img"){
			elem.attr("src", $(this).find("img").attr("src"));
			elem.attr("draggable", "false");
		}else if(elemName == "upload"){
			$(".tof-browser-element-input").remove();

			let browseImg = $("<input/>", {"type" : "file", "style" : "display:none", "class" : "tof-browser-element-input", "accept":".jpeg, .png, .jpg, .gif, .svg, .bmp, .webp, .tiff, .ico"});
			$("body").append(browseImg);
			browseImg.click();

			browseImg.on("change", function(){
				let uploadedElement = $(this)[0].files[0];
				
				var allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/svg+xml', 'image/bmp', 'image/webp', 'image/tiff', 'image/x-icon'];
    			
    			if(allowedTypes.includes(uploadedElement.type)){
					let reader = new FileReader();

					reader.onload = function(e){
						var elem = $(`<img/>`);

						elem.attr({
							"class" : "tof-preview-overlay-element",
							"data-on-page" : currentPage,
							"data-on-all" : "0"
						});


						elem.attr("src", e.target.result);
						elem.attr("draggable", "false");

						$(".tof-preview-overlay").append(elem);
					}

					reader.readAsDataURL(uploadedElement);
    			}
			});
		}else{
			elem.html($(this).attr("data-default-text"));
		}

		if(elemName != "upload"){
			$(".tof-preview-overlay").append(elem);
		}
	});

	$(".tof-input-mode-button").on("click", function(){
		let confirmUser = window.confirm("This will delete all your changes in Default mode. Do you want to proceed?")

		if(confirmUser){
			$("#tof-user-input").val("").trigger("input");
			$(".tof-input-section").toggleClass("classic");

			classicMode = !classicMode;
			$(`.tof-preview-overlay-element[data-on-page]`).remove();
		}
	});

	$(".tof-tool-page-elements").click(function(){
		$('.tof-tool-sidebar-tab[data-tab="styles"]').trigger("click");
		$("#tof-elements-section").find(".show-in-full").trigger("click");
	});

	$("#tof-add-page").click(function(){
		if(classicMode){
			addPage();
			updateNewStyle();
		}
	});

	$("#tof-delete-page").click(function(){
		if(classicMode){
			if(pageCount > 1){
				deletePage();
				updateNewStyle();
			}
		}
	});

	$("#tof-para-color-picker").on("input", function(){
		var selectedColor = $(this).val();
		$(".tof-selected-color-preview").css("background-color", selectedColor);
	});

	$("#tof-para-color-picker").trigger("input");

	$(".tof-color-picker-selected").on("click", function(){
		$("#tof-para-color-picker").click();
	});

	$(".tof-download-button").on("click", function(e){
		e.stopPropagation();

		$(".tof-formatting").removeClass("show");
		$(".tof-transform").addClass("hidden");
		$(".tof-tool-download-option").addClass("show");
	});

	$(document).on("click", function(){
		$(".tof-tool-download-option").removeClass("show");
	});

	$(".tof-tool-download-list").on("click", function(){
		let downloadBtn = $(".tof-download-button");
		downloadBtn.addClass("loader");

		let type = $(this).attr("data-name");

		let page = "all";
		let downloadType = "pdf";

		if(type == "all-pdf"){
		}else if(type == "this-pdf"){
			page = currentPage;
			downloadType = "pdf";
		}else if(type == "all-img"){
			page = "all";
			downloadType = "img";
		}else if(type == "this-img"){
			page = currentPage;
			downloadType = "img";
		}


		$(".tof-tool-wrapper").css("pointer-events", "none");
		$(".tof-preview-page").addClass("scaleToDefault");


		downloadPages(page, downloadType).then(res => {
			if(page == "all"){
				currentPage = 1;
				updateNewStyle();
			}

			downloadBtn.removeClass("loader");
			$(".tof-tool-wrapper").css("pointer-events", "auto");
			$(".tof-preview-page").removeClass("scaleToDefault");	
		});
	});

	
	let beforeUnloadAttached = false;

	const targetNodes = $(".tof-preview-text-content, .tof-preview-overlay").toArray();

	const observer = new MutationObserver((mutationList, observer) => {
	    for (const mutation of mutationList) {
	        if (mutation.type === "childList" && !beforeUnloadAttached) {
	            $(window).on('beforeunload', function() {
	                return 'Do you really want to leave?';
	            });

	            beforeUnloadAttached = true;
	        }
	    }
	});

	targetNodes.forEach((node) => {
	    observer.observe(node, { childList: true, subtree: true });
	});


	/**
	 * Update the filters
	 * on Document ready
	 */

	function downloadPages(index="all", type="pdf") {
		$(".download-loader, .tof-loader-overlay").removeClass("hidden")

		return new Promise((resolve, reject) => {
			if(index == "all"){
				currentPage = 1;
				let b64_files = [];
				let blob_files = [];

				function captureScreen() {
					var outputElem = $(".tof-preview-page");

					html2canvas(outputElem[0], {scale : 2}).then(function(canvas){
						canvas.toBlob(function(page_blob){
							var base64File = canvas.toDataURL("image/png");

							b64_files.push(base64File);
							blob_files.push(page_blob);

							if(currentPage < pageCount){
								currentPage++;

								updateNewStyle();
								captureScreen();
							}else{
								// All Files are Captured.. Download it
								if(type == "pdf"){
									const pdfWorker = new Worker("js/text-to-handwriting.js");

									pdfWorker.onmessage = function(event) {
									  if(event.data.status == "success"){
										saveAs(event.data.file, "1.pdf");
										$(".download-loader, .tof-loader-overlay").addClass("hidden")
										resolve("resolved");
										pdfWorker.terminate();
									  }
									};

									pdfWorker.onerror = function (e) {
									  pdfWorker.terminate();
									  resolve("resolved");
									};

									pdfWorker.postMessage({images: b64_files, width : outputElem.width(), height : outputElem.height()});
								}else{
									if(b64_files.length > 1){
										var zip = new JSZip();

										blob_files.forEach((blobFile, index) => {
											zip.file(`page_${index+1}.png`, blobFile);
										});	

										zip.generateAsync({ type: "blob" }).then(function (blob) {
										    saveAs(blob, "1.zip");
										    $(".download-loader, .tof-loader-overlay").addClass("hidden")
										    resolve("resolved");
										});
									}else{
										saveAs(b64_files[0], "1.png");
										$(".download-loader, .tof-loader-overlay").addClass("hidden")
										resolve("resolved");
									}
								}
							}
						});
					});
				}

				updateNewStyle();
				captureScreen();
			}else if(Number.isInteger(index)){
				if(index <= pageCount){
					currentPage = index;
					updateNewStyle();

					var outputElem = $(".tof-preview-page");

					html2canvas(outputElem[0], {scale : 2}).then(function(canvas){
						let base64Data = canvas.toDataURL("image/png");

						if(type == "pdf"){
							const pdfWorker = new Worker("js/text-to-handwriting.js");

							pdfWorker.onmessage = function(event) {
							  if(event.data.status == "success"){
								saveAs(event.data.file, "1.pdf");
								$(".download-loader, .tof-loader-overlay").addClass("hidden")
								resolve("resolved");
								pdfWorker.terminate();
							  }
							};

							pdfWorker.onerror = function (e) {
							  pdfWorker.terminate();
							  resolve("resolved");
							};

							pdfWorker.postMessage({ images: base64Data });
						}else{
							saveAs(base64Data, "1.png");
							$(".download-loader, .tof-loader-overlay").addClass("hidden")
							resolve("resolved");
						}
					});
				}
			}
		});
	}

	function isJSON(string) {
		try{
			JSON.parse(string);
		}
		catch(error){
			return false;
		}

		return true;
	}

	function addOverlayEffect() {
		var filterElem = $(".tof-overlay-effect");

		if(filters.captureEffect == "scanner" || filters.captureEffect == "shadow"){
			filterElem.removeClass("hidden");
		}else{
			filterElem.addClass("hidden");
		}

		let minAngle = 0;
		let maxAngle = 360;
		let randomAngle = 10;

		if(filters.captureEffect == "scanner"){
			minAngle = 50;
			maxAngle = 120;
	
			randomAngle = Math.floor(Math.random() * (maxAngle - minAngle)) + minAngle;
			
			filterElem.css('background-image', `linear-gradient(${randomAngle}deg, rgba(0, 0, 0, 0.2), transparent)`);
			$(".tof-preview-page").css("filter", "saturate(140%)");
		}else if(filters.captureEffect == "saturate"){
			filterElem.css('background-image', `linear-gradient(${randomAngle}deg, rgba(0, 0, 0, 0), transparent)`);
			$(".tof-preview-page").css("filter", "saturate(140%)");
		}else{
			randomAngle = Math.random() * maxAngle;

			filterElem.css('background-image', `linear-gradient(${randomAngle}deg, rgba(0, 0, 0, 0.3), transparent)`);
			$(".tof-preview-page").css("filter", "unset");
		}
	}

	updateFilters();
	function updateFilters() {
		// Add Page Background to filters

		if(!uploadedCustomPage){
			var selectedPage = $("#tof-page-style").find(".tof-sidebar-option-card.selected");
			var bg = selectedPage.find("img").attr("src");
			filters["background-image"] = `url(${bg})`;
		}

		// Add Font to Filters
		var selectedFont = $("#tof-page-font").find(".tof-sidebar-option-card.selected");
		var fontName = $(selectedFont).attr("data-font");
		filters["font-family"] = `"${fontName}", sans-serif`;


		$('[data-type="style-input"]').each((index, elem) => {
			if(filters.hasOwnProperty($(elem).attr("data-name"))){
				var value = $(elem).val();
				let name = $(elem).attr("data-name");

				if(name == "height"){
					value = (value < 100)?100:value;
				}else if(name == "width"){
					value = (value < 150)?150:value;
				}

				if(!isNaN(parseFloat(value))){
					value = value + "px";
				}

				filters[$(elem).attr("data-name")] = value;
			}
		});

		// Add Effect Filters
		addOverlayEffect();
	}

	function updateText(data){
		data = data.replaceAll("\n", "<br>").replaceAll("\t", "&nbsp;&nbsp;&nbsp;&nbsp;");
		var previewContent = $(".tof-preview-text-content");
		previewContent.html(data);
		updateStyle();
	}


	function updateStyle(){
		pageInfo = {};

		updateFilters();

		const exclude = ["page", "captureEffect"];
		for(key in filters){
			if(!exclude.includes(key)){
				if(key == 'background-image'){
					$(".tof-preview-page").css(`${key}`, `${filters[key]}`);
				}else{
					if(key == "font-family"){
						$(".tof-preview-overlay").css(key, filters[key]);
					}

					$(".tof-preview-content").css(`${key}`, `${filters[key]}`);
				}
			}
		}

		var previewContent = $(".tof-preview-text-content");
		var outerContent = $(".tof-preview-content");
		var lineHeight = parseFloat(filters["line-height"].split("px")[0]);
		var lineCount = Math.floor(outerContent.height() / lineHeight);

		var outerContentHeight = lineCount*lineHeight;
		outerContent.css("height", `${outerContentHeight}px`);

		updateNewStyle();
	}

	function addPage() {
		pageCount++;


		$(`.tof-preview-overlay-element[data-on-page]`).each(function(index, elem){
			var pageIndex = parseFloat($(elem).attr("data-on-page"));
			
			if(pageIndex > currentPage){
				pageIndex = pageIndex+1;
			}

			$(elem).attr("data-on-page", pageIndex);
		});

		if(currentPage < pageCount){
			currentPage++;
		}
	}

	function deletePage() {
		$(`.tof-preview-overlay-element[data-on-page="${currentPage}"]`).remove();

		$(`.tof-preview-overlay-element[data-on-page]`).each(function(index, elem){
			var pageIndex = parseFloat($(elem).attr("data-on-page"));
			
			if(pageIndex > currentPage){
				pageIndex = pageIndex-1;
			}

			$(elem).attr("data-on-page", pageIndex);
		});

		pageCount--;
		if(currentPage > 1){
			currentPage -= 1;
		}else{
			currentPage = 1;
		}
	}

	var pageInfo = {};

	function updateNewStyle() {
		if(!classicMode){
			let paperContent = $("#tof-user-input").val().replaceAll("<", "&lt;").replaceAll("\n", "<br>").replaceAll("\t", "&nbsp;&nbsp;&nbsp;&nbsp;");
			let splitContent = paperContent.split(/[ ]|(\<br\>)/);

			var previewContent = $(".tof-preview-text-content");
			var outerContent = $(".tof-preview-content");

			previewContent.html(paperContent);

			var outerContentHeight = outerContent.height();

			pageCount = Math.ceil(previewContent.height()/outerContentHeight);
			
			// pageCount += 1;
			let currentPageStatus = 1;

			let wordCount = 0;
			let wordArray = [];

			if(pageInfo.hasOwnProperty(currentPage - 1)){
				wordCount = pageInfo[currentPage - 1];

				wordArray = [];
				previewContent.empty();

				while(
					previewContent.height() <= outerContentHeight &&
					wordCount <= splitContent.length
				){
					wordArray.push(splitContent[wordCount]);
					wordCount++;

					previewContent.html(wordArray.join(" "));
				}

				if(previewContent.height() > outerContentHeight){
					wordCount--;
					wordArray.pop();

					previewContent.html(wordArray.join(" "));
				}

				pageInfo[currentPage] = wordCount;
			}else{
				for(let i=1; i<=pageCount; i++){

					if(currentPageStatus <= currentPage){
						currentPageStatus++;

						wordArray = [];
						previewContent.empty();

						while(
							previewContent.height() <= outerContentHeight &&
							wordCount <= splitContent.length
						){
							wordArray.push(splitContent[wordCount]);
							wordCount++;

							previewContent.html(wordArray.join(" "));
						}

						if(previewContent.height() > outerContentHeight){
							wordCount--;
							wordArray.pop();

							previewContent.html(wordArray.join(" "));
						}

						pageInfo[currentPage] = wordCount;
					}
				}
			}


			pageCount = (pageCount == 0)?1:pageCount;

			if(currentPage > pageCount){
				currentPage = pageCount;
			}
		}

		$(".tof-tool-page-info-name").html(`${currentPage}<span>/</span>${pageCount}`);

		if(currentPage > 1){
			$("#tof-prev-page").addClass("active");
		}else{
			$("#tof-prev-page").removeClass("active");
		}

		if(pageCount > 1){
			$("#tof-next-page").addClass("active");
		}

		if(currentPage == pageCount){
			$("#tof-next-page").removeClass("active");
		}


		$(".tof-preview-overlay-element").addClass("hidden");
		$(`.tof-preview-overlay-element[data-on-page="${currentPage}"]`).removeClass("hidden");
		$(`.tof-preview-overlay-element[data-on-all="1"]`).removeClass("hidden");

		addOverlayEffect();
	}

	var data = []
	var columns = []

	$(".tof-tool-import-excel").on("click", function(){
		$('[data-type="style-input"][data-name="captureEffect"]').val("normal").trigger("input");
	});

	$(".excel-import-droper").on("click", function(){
		var filePicker = $("<input>", {"type":"file", "accept":".xlsx, .xls", "display":"none"})
		$("body").append(filePicker);
		filePicker.trigger("click");

		filePicker.on("change", function(){
			var file = this.files[0]
			filePicker.remove()

			if(file.name.split(".").pop() == "xlsx" || file.name.split(".").pop() == "xls"){
				$(".excel-import-droper").find("span").text(file.name)

				readXlsxFile(file).then((excelData) => {
					$(".excel-import-result").html("")
					data = excelData
					
					var isFirstRowColumn = $("#isFirstRowColumn").is(":checked")

					if(isFirstRowColumn){
						excelData[0].forEach((value, index) => {
							columns.push(value)
							$(".excel-import-result").append(`<div class="excel-placeholder tof-add-element-list" data-element="p" data-column="${index}" data-default-text="{{${value}}}">${value}</div>`)
						});
					}else{
						excelData[0].forEach((value, index) => {
							columns.push(`Column ${index+1}`)
							$(".excel-import-result").append(`<div class="excel-placeholder tof-add-element-list" data-element="p" data-column="${index}" data-default-text="{{Column ${index+1}}}">Column ${index+1}</div>`)
						});
					}
				});
			}else{
				alert("not allowed");
			}
		});
	});

	$("#resetExcel").on("click", function(){
		pageCount = 1;
		currentPage = 1;

		updateNewStyle()
		$(".tof-preview-overlay-element").remove()
		$(".excel-import-droper span").text("Import Excel");
	});

	$("#convertExcelToPdf").on("click", function(){
		$("#tof-user-input").val("").trigger("input");
		$(".tof-input-section").toggleClass("classic");
		classicMode = true;

		// Doo the processing
		var isFirstRowColumn = $("#isFirstRowColumn").is(":checked")

		if(data.length > 1){
			pageCount = data.length - 1
			currentPage = 1

			if(!isFirstRowColumn){
				pageCount = data.length
			}

			updateNewStyle()

			var placeholders = $(".tof-preview-overlay-element[data-excel-placeholder='1']")

			for(var i=0; i<data.length; i++){
				if(isFirstRowColumn){
					if(i == 0){
						continue
					}
				}


				placeholders.each((index, elem) => {
					var columnIndex = $(elem).attr("data-excel-column")
					var rowElem = $(elem).clone()

					var allotedPage = i+1

					if(isFirstRowColumn){
						allotedPage = i
					}

					rowElem.attr({
						"data-on-page" : allotedPage,
						"data-on-all" : "0"
					});

					rowElem.removeAttr("data-excel-placeholder");

					
					if(rowElem.html().indexOf(`{{${columns[index]}}}`) === -1){
						rowElem.text(data[i][columnIndex])
					}else{
						rowElem.html(rowElem.html().replaceAll(`{{${columns[index]}}}`, data[i][columnIndex]));
					}

					$(".tof-preview-overlay").append(rowElem);

					elem.remove()
				});

			}
		}else{
			alert("Make sure you have atleast two rows in your excel file")
		}
	});	
});